# Session 4 â€” Day 4: Maps Platform Decision

**Date:** 2026-02-05 | **Model:** Sonnet | **Status:** COMPLETE

---

## What happened

Day 4 decision sprint: maps platform selection.

The roadmap originally framed this as a binary (Google Maps JS SDK vs OSM + OpenLayers) for a single "Point Routes" feature. Product discovery at session start revealed two distinct maps with different needs:

1. **Map A â€” Campus & CHK:** Indoor wayfinding, floor plans, place-finding. Floor-plan data does not exist yet â€” this map is gated on sourcing that data. Lower priority.
2. **Map B â€” Point (bus routes):** 20â€“30 undigitised bus routes used daily by 90 % of students. Place-search ("I want to go to X in Karachi, which bus?") + Phase 2 live GPS tracking. Highest daily-engagement feature in the product.

### Research surfaced a third option the roadmap didn't name

OpenLayers (the roadmap's OSM candidate) has documented WebView flicker and GC-pause issues on mid-range Android â€” exactly the hardware our users carry. MapLibre GL JS, the open-source WebGL-native fork of Mapbox GL, benchmarks clearly ahead of OpenLayers on that hardware and has first-class PMTiles offline support.

### Decision: MapLibre GL JS + PMTiles + Google Geocoding (scoped)

- **Tiles:** PMTiles single-file extract of Karachi metro, hosted on Supabase Storage. Offline-capable. Zero per-load cost.
- **Geocoding:** Google Geocoding fires only on a student's place-search query (~24 000 calls / month at 2 000 DAU). ~$70 / month. Cached per Google ToS to reduce repeat calls.
- **Live tracking (Phase 2):** Driver phone GPS â†’ Supabase Realtime Broadcast â†’ MapLibre GeoJSON source update. No Postgres writes for location. Ephemeral, low-latency.
- **Total maps cost: ~$70 / month.** 5Ã— cheaper than Google Maps JS SDK for the same features.

### Key architectural choices and why

| Choice | Why |
|---|---|
| Haversine client-side for stop matching | Students ask "which bus?" not "give me turn-by-turn walking directions." Nearest stop within 200â€“400 m is the answer. Zero API calls, < 1 ms. |
| Broadcast, not Postgres Changes, for live GPS | Positions are ephemeral. Broadcast is fire-and-forget over WebSocket â€” zero DB write load for location updates. |
| Campus map gated on floor-plan data | No floor plans exist. Building a map renderer for data that doesn't exist wastes a sprint. Architecture is specified in the doc so Phase 5 can build straight to it when data arrives. |
| Single MapLibre instance for both maps | Same library, same tile source, different GeoJSON layers. No reason to maintain two rendering stacks. |

## Files touched

- `docs/decisions/maps-platform.md` â€” new, LOCKED
- `docs/todo-current.md` â€” Day 4 ticked off

## State of the project

- Days 1â€“4 complete. Decision docs written: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`.
- Days 5â€“9 remaining in Phase 1 (Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off).

---

## Session 4b â€” Campus map MVP plan (same day, continued)

### What happened

The Â§4.4 stub in `maps-platform.md` ("blocked until floor-plan data is sourced") was replaced with a full MVP spec after product discovery with the owner. Key findings:

- Dow main building (all floors) is the MVP scope. CHK added later.
- CAD/PDF floor plans **can** be requested from admin â€” this is the fastest path and the plan assumes it.
- Team is willing to learn QGIS for the tracing work. One person georefs, others trace in parallel.
- Navigation depth for MVP is **pin + floor indicator only** â€” no indoor routing graph. Students search, see the floor and the highlighted room, walk there. Keeps the data model and build scope tight.
- POI categories: Departments/Wards, Labs, Classrooms, Facilities (canteen, library, prayer, toilets).

### What was written

`maps-platform.md` now contains:

- **Â§4.4.1** â€” POI category taxonomy + icon mapping (all Lucide, already installed)
- **Â§4.4.2** â€” Full MapLibre layer stack (6 layers, render order specified)
- **Â§4.4.3** â€” Floor pill selector UX: auto-selects on search, animates camera bbox
- **Â§4.4.4** â€” Supabase data model: `campus_buildings`, `campus_floors`, `campus_places` tables with RLS (read-only authenticated, write service-role only)
- **Â§4.4.5** â€” Search â†’ highlight flow: fully client-side, no geocoding, fuzzy match on < 200 rows
- **Â§4.4.6** â€” Step-by-step QGIS digitisation workflow the team will actually follow (6 steps: request â†’ georeference â†’ trace â†’ label POIs â†’ export per-floor GeoJSON â†’ seed Supabase)
- **Â§6 Pre-build dependency** â€” Digitisation schedule that runs in parallel with Phase 3â€“4 coding. Estimated 1 person-day per floor, spread across 2 people over ~1 week. Admin email goes out Day 10.
- **Â§6 Phase 5 Map A** â€” 5-day build schedule (Days 31â€“35) with a fallback gate on Day 35: if GeoJSON isn't ready, ship a simplified version (no room polygons, no floor selector) and add the full indoor map in a follow-up.

### Key design decisions

| Decision | Why |
|---|---|
| Per-floor GeoJSON files, not one giant file | MapLibre swaps the active floor's layer in O(1). Only one floor's polygons are rendered at a time â€” keeps GPU load flat regardless of building size. |
| `room_polygon_id` link from POI to room polygon | Enables the highlight layer to show exactly which room the student searched for. Without this link, you'd have to spatial-join at runtime. |
| Fuzzy match client-side, not server search | < 200 POIs. A simple string-distance match takes microseconds. No Supabase query, no latency, works offline. |
| Fallback gate on Day 35 | Digitisation depends on admin handing over PDFs. If that's slow, the map still ships â€” just without indoor detail. The Point map (higher priority) is unaffected either way. |

## Files touched (cumulative)

- `docs/decisions/maps-platform.md` â€” Â§4.4 fully specced, Â§6 campus schedule added, Â§7 sources updated
- `docs/todo-current.md` â€” Day 4 ticked off
- `docs/sessions/2026-02-05-session-4.md` â€” this file

## State of the project

- Days 1â€“4 complete. Decision docs written: `rag-architecture.md`, `model-selection.md`, `maps-platform.md` (both maps fully specced).
- Days 5â€“9 remaining in Phase 1.
- Campus digitisation is now a tracked parallel workstream starting Day 10.

---

## Session 4c â€” Education tab + Mobile/Web UI decisions (same day, continued)

### What happened

Two new decision docs written after product discovery expanded the scope beyond the PRD.

**Education tab** â€” PRD had three features (MCQ, Viva, Progress). Discovery added three Phase 2 features: Saved Questions, Quick Summaries, Flashcards. MCQ also has a two-source split (Past Papers vs External) that wasn't in the PRD. Key calls:

- Education is one tab, cards grid landing screen. Each card is a `<Link>` to its sub-page. Adding a Phase 2 feature = one new card, no restructure.
- AI Tutor stays as its own top-level nav item (flagship feature, one tap from anywhere).
- MCQ flow: module picker first (what students think about), then a Past Papers / All Sources toggle. Past Papers is the default â€” highest yield by definition.
- Route tree is flat under `/education/` â€” each feature is a direct sub-route. No nested intermediate screens.

**Mobile vs Web UI** â€” usage split is roughly equal, but the *type* of usage differs: phone for quick drills + maps, laptop for longer study sessions. This drove the key divergence:

- Mobile: 5-item bottom nav (Dashboard, Education, AI Tutor, Community, Maps). Everything else is reachable from within.
- Desktop: sidebar with grouped sections. The "Study" section **flattens** all Education sub-features (MCQ, Viva, Progress, and Phase 2 additions) as direct sidebar links â€” no intermediate Education landing screen. Students in a study session want one tap to each tool.
- Desktop sidebar also has a "System" section: Settings, Profile, Admin (role-gated), Help. These don't exist on mobile bottom nav â€” accessed via avatar tap â†’ bottom sheet instead.
- **One component tree, two layout wrappers.** Every page is written once. `(app)/layout.tsx` renders either `<BottomNav>` or `<Sidebar>` based on viewport. The nav config is data-driven (a `nav.ts` array) â€” adding a sidebar item is one object, no JSX changes.
- Bottom sheets (mobile) become right-side panels or modals (desktop) via a shared `side` prop. No duplicated components.

### Files touched (cumulative)

- `docs/decisions/education-tab.md` â€” new, LOCKED
- `docs/decisions/mobile-web-ui.md` â€” new, LOCKED
- `docs/todo-current.md` â€” Education tab + Mobile/Web UI items added

### State of the project

- Days 1â€“4 complete. Decision docs: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`, `education-tab.md`, `mobile-web-ui.md`.
- Days 5â€“9 remaining in Phase 1 (Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off).
- Campus digitisation tracked as a parallel workstream starting Day 10.

---

## Session 4d â€” All-pages UI structure (same day, continued)

### What happened

Product discovery expanded scope beyond the existing decision docs. Two things changed the nav and added a big new doc:

1. **Community â†’ Campus rename.** The 4th nav tab is now "Campus" and owns all campus-life + revenue features: DowEats, Merch, Marketplace, Lost & Found, Prayer Times. `mobile-web-ui.md` nav config updated accordingly.

2. **`ui-page-structure.md` written** â€” covers every screen in the app in one doc because they cross-link heavily (dashboard cards tap into timetable, L&F, prayers, announcements; prayers cross-links to campus map; announcements are audience-filtered per student).

### Key decisions made

| Decision | Why |
|---|---|
| Dashboard widget order: exam countdown â†’ timetable â†’ attendance â†’ announcements â†’ prayers â†’ L&F | Time-sensitivity. Exam countdown is the single most urgent piece of info. Prayers and L&F are "nice to have at a glance" â€” bottom of the stack. |
| Mark Present / Absent buttons on dashboard mini card | Students mark attendance when they see "next class" â€” not by hunting for a timetable page. Reduces friction to zero for the 90 % case. Buttons only appear once the class has started and disappear 30 min after it ends. |
| Full timetable is a sub-route of Dashboard (`/dashboard/timetable`), not a nav item | Timetable is accessed daily but doesn't need a permanent nav slot. The dashboard mini card is the entry point. Keeps bottom nav at 5 items. |
| Prayer times calculated client-side via `adhan` library | Karachi coordinates are fixed. Sun-position math works offline, costs $0, and is accurate. No API dependency. Masjid congregational times are the only thing that needs manual updating (imam has a role-gated form). |
| Announcements filtered by audience (all / batch / module) | A Surgery module announcement shouldn't appear for a student in Anatomy. Client-side filter after fetch â€” the query is simple and the dataset is small. |
| Revenue feature cards show "Coming Soon" from day one | Keeps the Campus cards grid layout stable. No visual shift when DowEats/Merch/Marketplace ship. Students can see what's planned. |
| Lost & Found: dashboard card + full page under Campus | Dashboard card = quick scan of latest 2-3 posts. Full page = search, filter, post. Both entry points, one component. |
| Qibla + Hijri date calculated client-side | Same principle as prayer times. Two npm libraries (`adhan` for qibla bearing, `hijri-converter` for date). Zero API calls, works offline. |

### Files touched (cumulative this session)

- `docs/decisions/ui-page-structure.md` â€” new, LOCKED
- `docs/decisions/mobile-web-ui.md` â€” nav config updated (Community â†’ Campus, sidebar sections restructured)
- `docs/todo-current.md` â€” Education tab, Mobile/Web UI, and all-pages UI items ticked off

### State of the project

- Days 1â€“4 complete. Decision docs: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`, `education-tab.md`, `mobile-web-ui.md`, `ui-page-structure.md`.
- Every screen in the app is now specced. Route tree is complete. What's left in Phase 1 is the remaining decision days (5â€“9): Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off.
- Campus digitisation tracked as parallel workstream from Day 10.

---

## Session 4e â€” Glassmorphic student card + UX improvements (same day, continued)

### What happened

Two things were specced: (a) a glassmorphic student card for the Profile page + sidebar avatar, and (b) a set of app-wide UX conventions derived from the `ui-ux-pro-max` and `tailwind-design-system` skills.

**User answers that shaped the spec:**
- Card placement: full card on Profile only; sidebar gets a compact avatar mini-card (48 px + Pro ring). Dashboard greeting stays text-only.
- Photo: separate selfie, uploadable any time from Profile. Not the Dow ID photo from onboarding.
- Extra info on card: Pro badge / Upgrade CTA, current module name, Dow Credits balance. (Lab group was offered but not selected.)

**Glassmorphic card spec:**
- Uses the glassmorphism card already in `4_DESIGN_SYSTEM.md` as the base: `bg white/80`, `backdrop-blur-md`, `border white/30`, shadow.
- Avatar border is Gold `#D4A574` (3 px) if Pro; Navy-200 `#D1DCEB` if Free.
- Card shadow gets a subtle Gold tint (`rgba(212,165,116,0.25)`) if Pro â€” the only visual difference at the card level besides the badge.
- Dark-mode variants specified (Gold brightens to `#FFD89B`, card bg shifts to `rgba(34,47,69,0.85)`).
- Photo upload: bottom sheet (mobile) / modal (desktop) â†’ camera or library picker â†’ client-side circular crop â†’ WebP upload to Supabase Storage â†’ `users.avatar_url` update. Falls back to initials-in-circle if no photo.
- Skeleton state mirrors card shape (circle + lines) while profile data loads â€” uses shadcn `<Skeleton>` + `motion-safe:animate-pulse`.

**UX conventions locked in (app-wide):**
- Dashboard greeting is time-aware (morning/afternoon/evening/night) using first name only. Asia/Karachi timezone.
- Every async page renders skeleton-first (no full-page spinners). Each widget / list section skeletonises independently.
- Transition timing scale locked: 100 ms (tap), 150 ms (hover), 200 ms (route/fade), 250 ms (sheet). Only `transform` + `opacity` â€” never `width`/`height`.
- Touch targets: `+ Add photo` link and Pro badge CTA get 44 Ã— 44 px hit areas even though they're visually small.
- Focus rings: `focus-visible:ring-2 ring-teal-500 ring-offset-2` everywhere.
- Contrast: sub-text on glass cards uses `#5A6B8A` (passes 4.5:1 against white-80). Never Navy-300 for text.
- `prefers-reduced-motion`: all skeleton pulses use `motion-safe:animate-pulse`.
- Avatar images use `next/image` with explicit dimensions + `priority` on Profile (above fold).

### Key decisions made

| Decision | Why |
|---|---|
| Card on Profile only, not Dashboard | Dashboard is a scannable widget stack. Putting the full card there would eat vertical real estate that belongs to time-sensitive widgets. The sidebar avatar handles identity recognition on desktop. |
| Selfie separate from Dow ID photo | Dow ID goes through an approval flow (admin verifies). A profile selfie is casual and instant â€” different purpose, different upload path. |
| Credits balance on the card | Students top up Credits before paying for Pro or using DowEats. Seeing the balance on their "identity card" makes it a natural place to check before spending. |
| Sub-text colour `#5A6B8A` not Navy-300 | Navy-300 (`#A5B8D6`) fails 4.5:1 against the glass background. `#5A6B8A` is the lightest mid-tone that passes. Skill confirmed: "Light mode text has sufficient contrast (4.5:1 minimum)." |
| Skeleton-first, not spinner-first | Per `ui-ux-pro-max`: "Show skeleton screens or spinners" with severity High. Per Next.js stack: "Reserve space for dynamic content." Skeleton preserves layout shape and feels faster than a centred spinner. |

### Files touched (cumulative this session)

- `docs/decisions/profile-card-ux.md` â€” new, LOCKED
- `docs/decisions/ui-page-structure.md` â€” Â§3.1 greeting spec added, Â§10 Profile wireframe replaced with glassmorphic card
- `docs/decisions/mobile-web-ui.md` â€” sidebar wireframe updated with avatar mini-card, sources updated

### State of the project

- Days 1â€“4 complete. Decision docs: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`, `education-tab.md`, `mobile-web-ui.md`, `ui-page-structure.md`, `profile-card-ux.md`.
- Every screen is specced. The glassmorphic card component + avatar upload + all UX conventions are ready to build in Phase 2 Days 10â€“11.
- Days 5â€“9 remain: Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off.

---

---

## Session 4f â€” Deep audit + todo rewrite + Windsurf handoff plan (same day, continued)

### What happened

Full audit of every doc in the project. Cross-referenced `FINAL_LOCKED_DECISIONS.md`, `00_DISCOVERY_RESOLVED.md`, `5_UXUI_GUIDELINES.md`, `01_PRD_OVERVIEW.md`, all 7 decision docs, and the roadmap.

### Decisions found that were already made but had no decision doc

These all live in `FINAL_LOCKED_DECISIONS.md` as flat answers. They need proper decision docs before Windsurf can build from them:

| Decision | What's locked | Doc to write |
|---|---|---|
| Dow Credits top-up | Easypaisa / JazzCash â†’ manual verify 5â€“10 min | `credits-payment.md` |
| Pro upgrade flow | Credits deduct PKR 3 000 / yr, annual | merged into `credits-payment.md` |
| DowEats ops | Item-first menu, 6-digit code, gate delivery, 12â€“1:30 peak | `doweats-ops.md` |
| Marketplace withdrawal | Manual, PKR 500 min, 0% fees, 2â€“5 days | `marketplace-ops.md` |
| Viva scoring | 3 modes, 50-point scale, per-dimension weights | `viva-scoring.md` |
| L&F contact | Full number + WhatsApp, trust model, 30-day archive | Already in `ui-page-structure.md` Â§7 â€” fine |

### Conflicts and stale docs found

| Issue | Where | Severity |
|---|---|---|
| **Rate limit conflict** | `FINAL_LOCKED_DECISIONS.md` says 20 soft / 50 hard. `rag-architecture.md` + CLAUDE.md say 2 soft / 4 hard. | ðŸ”´ Must resolve Day 9. 2/4 is almost certainly correct â€” the 20/50 predates the cost model. |
| **Nav structure stale** | `5_UXUI_GUIDELINES.md` Â§2â€“3 still shows old 5-tab nav (Timetable / Attendance / Learning / Community / Account). | ðŸŸ¡ Update before Day 10. |
| **Maps section stale** | `00_DISCOVERY_RESOLVED.md` says "Google Maps SDK" | ðŸŸ¡ Update before Day 10. Superseded by MapLibre. |
| **`FINAL_LOCKED_DECISIONS.md` is a legacy flat file** | 340 lines of Q&A format. No pointers to the new decision docs. | ðŸŸ¡ Rewrite as an index on Day 9. |

### Windsurf handoff docs identified

Eight docs that don't exist yet but Windsurf needs to build without ambiguity. Tracked in the new "Windsurf Handoff" section of `todo-current.md`. The most critical is `windsurf-rules.md` â€” the `.windsurf/rules` always-on context file. Write on Day 9 after all decisions are locked.

### Files touched

- `docs/todo-current.md` â€” full rewrite. Expanded to cover: all locked decisions with summaries, new product/operational decision items, stale doc reconciliation checklist, Phase 2 build items (expanded with glassmorphic card + sidebar avatar + admin queue), parallel workstream, and the Windsurf Handoff table.

### State of the project

- Days 1â€“4 complete. 7 decision docs locked. 4 stale docs flagged for reconciliation before Day 10.
- Days 5â€“9 remain: 4 tech decisions + 1 sign-off + 6 product/operational decision docs to write.
- Phase 2 coding (Days 10â€“16) is fully planned in the todo. Windsurf handoff docs are the gate â€” nothing codes until they're written.

---

## What comes next

- **Day 5:** Voice / STT decision â€” test Pakistani-accent accuracy across Web Speech API, OpenAI Whisper, and Google Cloud Speech-to-Text.
- **Day 5â€“6 (parallel):** Write `credits-payment.md` (quick â€” the mechanism is already decided, just needs the UX flow formalised).
