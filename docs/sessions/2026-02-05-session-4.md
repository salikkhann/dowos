# Session 4 — Day 4: Maps Platform Decision

**Date:** 2026-02-05 | **Model:** Sonnet | **Status:** COMPLETE

---

## What happened

Day 4 decision sprint: maps platform selection.

The roadmap originally framed this as a binary (Google Maps JS SDK vs OSM + OpenLayers) for a single "Point Routes" feature. Product discovery at session start revealed two distinct maps with different needs:

1. **Map A — Campus & CHK:** Indoor wayfinding, floor plans, place-finding. Floor-plan data does not exist yet — this map is gated on sourcing that data. Lower priority.
2. **Map B — Point (bus routes):** 20–30 undigitised bus routes used daily by 90 % of students. Place-search ("I want to go to X in Karachi, which bus?") + Phase 2 live GPS tracking. Highest daily-engagement feature in the product.

### Research surfaced a third option the roadmap didn't name

OpenLayers (the roadmap's OSM candidate) has documented WebView flicker and GC-pause issues on mid-range Android — exactly the hardware our users carry. MapLibre GL JS, the open-source WebGL-native fork of Mapbox GL, benchmarks clearly ahead of OpenLayers on that hardware and has first-class PMTiles offline support.

### Decision: MapLibre GL JS + PMTiles + Google Geocoding (scoped)

- **Tiles:** PMTiles single-file extract of Karachi metro, hosted on Supabase Storage. Offline-capable. Zero per-load cost.
- **Geocoding:** Google Geocoding fires only on a student's place-search query (~24 000 calls / month at 2 000 DAU). ~$70 / month. Cached per Google ToS to reduce repeat calls.
- **Live tracking (Phase 2):** Driver phone GPS → Supabase Realtime Broadcast → MapLibre GeoJSON source update. No Postgres writes for location. Ephemeral, low-latency.
- **Total maps cost: ~$70 / month.** 5× cheaper than Google Maps JS SDK for the same features.

### Key architectural choices and why

| Choice | Why |
|---|---|
| Haversine client-side for stop matching | Students ask "which bus?" not "give me turn-by-turn walking directions." Nearest stop within 200–400 m is the answer. Zero API calls, < 1 ms. |
| Broadcast, not Postgres Changes, for live GPS | Positions are ephemeral. Broadcast is fire-and-forget over WebSocket — zero DB write load for location updates. |
| Campus map gated on floor-plan data | No floor plans exist. Building a map renderer for data that doesn't exist wastes a sprint. Architecture is specified in the doc so Phase 5 can build straight to it when data arrives. |
| Single MapLibre instance for both maps | Same library, same tile source, different GeoJSON layers. No reason to maintain two rendering stacks. |

## Files touched

- `docs/decisions/maps-platform.md` — new, LOCKED
- `docs/todo-current.md` — Day 4 ticked off

## State of the project

- Days 1–4 complete. Decision docs written: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`.
- Days 5–9 remaining in Phase 1 (Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off).

## What comes next

- **Day 5:** Voice / STT decision — test Pakistani-accent accuracy across Web Speech API, OpenAI Whisper, and Google Cloud Speech-to-Text.
