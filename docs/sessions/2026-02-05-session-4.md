# Session 4 — Day 4: Maps Platform Decision

**Date:** 2026-02-05 | **Model:** Sonnet | **Status:** COMPLETE

---

## What happened

Day 4 decision sprint: maps platform selection.

The roadmap originally framed this as a binary (Google Maps JS SDK vs OSM + OpenLayers) for a single "Point Routes" feature. Product discovery at session start revealed two distinct maps with different needs:

1. **Map A — Campus & CHK:** Indoor wayfinding, floor plans, place-finding. Floor-plan data does not exist yet — this map is gated on sourcing that data. Lower priority.
2. **Map B — Point (bus routes):** 20–30 undigitised bus routes used daily by 90 % of students. Place-search ("I want to go to X in Karachi, which bus?") + Phase 2 live GPS tracking. Highest daily-engagement feature in the product.

### Research surfaced a third option the roadmap didn't name

OpenLayers (the roadmap's OSM candidate) has documented WebView flicker and GC-pause issues on mid-range Android — exactly the hardware our users carry. MapLibre GL JS, the open-source WebGL-native fork of Mapbox GL, benchmarks clearly ahead of OpenLayers on that hardware and has first-class PMTiles offline support.

### Decision: MapLibre GL JS + PMTiles + Google Geocoding (scoped)

- **Tiles:** PMTiles single-file extract of Karachi metro, hosted on Supabase Storage. Offline-capable. Zero per-load cost.
- **Geocoding:** Google Geocoding fires only on a student's place-search query (~24 000 calls / month at 2 000 DAU). ~$70 / month. Cached per Google ToS to reduce repeat calls.
- **Live tracking (Phase 2):** Driver phone GPS → Supabase Realtime Broadcast → MapLibre GeoJSON source update. No Postgres writes for location. Ephemeral, low-latency.
- **Total maps cost: ~$70 / month.** 5× cheaper than Google Maps JS SDK for the same features.

### Key architectural choices and why

| Choice | Why |
|---|---|
| Haversine client-side for stop matching | Students ask "which bus?" not "give me turn-by-turn walking directions." Nearest stop within 200–400 m is the answer. Zero API calls, < 1 ms. |
| Broadcast, not Postgres Changes, for live GPS | Positions are ephemeral. Broadcast is fire-and-forget over WebSocket — zero DB write load for location updates. |
| Campus map gated on floor-plan data | No floor plans exist. Building a map renderer for data that doesn't exist wastes a sprint. Architecture is specified in the doc so Phase 5 can build straight to it when data arrives. |
| Single MapLibre instance for both maps | Same library, same tile source, different GeoJSON layers. No reason to maintain two rendering stacks. |

## Files touched

- `docs/decisions/maps-platform.md` — new, LOCKED
- `docs/todo-current.md` — Day 4 ticked off

## State of the project

- Days 1–4 complete. Decision docs written: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`.
- Days 5–9 remaining in Phase 1 (Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off).

---

## Session 4b — Campus map MVP plan (same day, continued)

### What happened

The §4.4 stub in `maps-platform.md` ("blocked until floor-plan data is sourced") was replaced with a full MVP spec after product discovery with the owner. Key findings:

- Dow main building (all floors) is the MVP scope. CHK added later.
- CAD/PDF floor plans **can** be requested from admin — this is the fastest path and the plan assumes it.
- Team is willing to learn QGIS for the tracing work. One person georefs, others trace in parallel.
- Navigation depth for MVP is **pin + floor indicator only** — no indoor routing graph. Students search, see the floor and the highlighted room, walk there. Keeps the data model and build scope tight.
- POI categories: Departments/Wards, Labs, Classrooms, Facilities (canteen, library, prayer, toilets).

### What was written

`maps-platform.md` now contains:

- **§4.4.1** — POI category taxonomy + icon mapping (all Lucide, already installed)
- **§4.4.2** — Full MapLibre layer stack (6 layers, render order specified)
- **§4.4.3** — Floor pill selector UX: auto-selects on search, animates camera bbox
- **§4.4.4** — Supabase data model: `campus_buildings`, `campus_floors`, `campus_places` tables with RLS (read-only authenticated, write service-role only)
- **§4.4.5** — Search → highlight flow: fully client-side, no geocoding, fuzzy match on < 200 rows
- **§4.4.6** — Step-by-step QGIS digitisation workflow the team will actually follow (6 steps: request → georeference → trace → label POIs → export per-floor GeoJSON → seed Supabase)
- **§6 Pre-build dependency** — Digitisation schedule that runs in parallel with Phase 3–4 coding. Estimated 1 person-day per floor, spread across 2 people over ~1 week. Admin email goes out Day 10.
- **§6 Phase 5 Map A** — 5-day build schedule (Days 31–35) with a fallback gate on Day 35: if GeoJSON isn't ready, ship a simplified version (no room polygons, no floor selector) and add the full indoor map in a follow-up.

### Key design decisions

| Decision | Why |
|---|---|
| Per-floor GeoJSON files, not one giant file | MapLibre swaps the active floor's layer in O(1). Only one floor's polygons are rendered at a time — keeps GPU load flat regardless of building size. |
| `room_polygon_id` link from POI to room polygon | Enables the highlight layer to show exactly which room the student searched for. Without this link, you'd have to spatial-join at runtime. |
| Fuzzy match client-side, not server search | < 200 POIs. A simple string-distance match takes microseconds. No Supabase query, no latency, works offline. |
| Fallback gate on Day 35 | Digitisation depends on admin handing over PDFs. If that's slow, the map still ships — just without indoor detail. The Point map (higher priority) is unaffected either way. |

## Files touched (cumulative)

- `docs/decisions/maps-platform.md` — §4.4 fully specced, §6 campus schedule added, §7 sources updated
- `docs/todo-current.md` — Day 4 ticked off
- `docs/sessions/2026-02-05-session-4.md` — this file

## State of the project

- Days 1–4 complete. Decision docs written: `rag-architecture.md`, `model-selection.md`, `maps-platform.md` (both maps fully specced).
- Days 5–9 remaining in Phase 1.
- Campus digitisation is now a tracked parallel workstream starting Day 10.

---

## Session 4c — Education tab + Mobile/Web UI decisions (same day, continued)

### What happened

Two new decision docs written after product discovery expanded the scope beyond the PRD.

**Education tab** — PRD had three features (MCQ, Viva, Progress). Discovery added three Phase 2 features: Saved Questions, Quick Summaries, Flashcards. MCQ also has a two-source split (Past Papers vs External) that wasn't in the PRD. Key calls:

- Education is one tab, cards grid landing screen. Each card is a `<Link>` to its sub-page. Adding a Phase 2 feature = one new card, no restructure.
- AI Tutor stays as its own top-level nav item (flagship feature, one tap from anywhere).
- MCQ flow: module picker first (what students think about), then a Past Papers / All Sources toggle. Past Papers is the default — highest yield by definition.
- Route tree is flat under `/education/` — each feature is a direct sub-route. No nested intermediate screens.

**Mobile vs Web UI** — usage split is roughly equal, but the *type* of usage differs: phone for quick drills + maps, laptop for longer study sessions. This drove the key divergence:

- Mobile: 5-item bottom nav (Dashboard, Education, AI Tutor, Community, Maps). Everything else is reachable from within.
- Desktop: sidebar with grouped sections. The "Study" section **flattens** all Education sub-features (MCQ, Viva, Progress, and Phase 2 additions) as direct sidebar links — no intermediate Education landing screen. Students in a study session want one tap to each tool.
- Desktop sidebar also has a "System" section: Settings, Profile, Admin (role-gated), Help. These don't exist on mobile bottom nav — accessed via avatar tap → bottom sheet instead.
- **One component tree, two layout wrappers.** Every page is written once. `(app)/layout.tsx` renders either `<BottomNav>` or `<Sidebar>` based on viewport. The nav config is data-driven (a `nav.ts` array) — adding a sidebar item is one object, no JSX changes.
- Bottom sheets (mobile) become right-side panels or modals (desktop) via a shared `side` prop. No duplicated components.

### Files touched (cumulative)

- `docs/decisions/education-tab.md` — new, LOCKED
- `docs/decisions/mobile-web-ui.md` — new, LOCKED
- `docs/todo-current.md` — Education tab + Mobile/Web UI items added

### State of the project

- Days 1–4 complete. Decision docs: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`, `education-tab.md`, `mobile-web-ui.md`.
- Days 5–9 remaining in Phase 1 (Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off).
- Campus digitisation tracked as a parallel workstream starting Day 10.

---

## Session 4d — All-pages UI structure (same day, continued)

### What happened

Product discovery expanded scope beyond the existing decision docs. Two things changed the nav and added a big new doc:

1. **Community → Campus rename.** The 4th nav tab is now "Campus" and owns all campus-life + revenue features: DowEats, Merch, Marketplace, Lost & Found, Prayer Times. `mobile-web-ui.md` nav config updated accordingly.

2. **`ui-page-structure.md` written** — covers every screen in the app in one doc because they cross-link heavily (dashboard cards tap into timetable, L&F, prayers, announcements; prayers cross-links to campus map; announcements are audience-filtered per student).

### Key decisions made

| Decision | Why |
|---|---|
| Dashboard widget order: exam countdown → timetable → attendance → announcements → prayers → L&F | Time-sensitivity. Exam countdown is the single most urgent piece of info. Prayers and L&F are "nice to have at a glance" — bottom of the stack. |
| Mark Present / Absent buttons on dashboard mini card | Students mark attendance when they see "next class" — not by hunting for a timetable page. Reduces friction to zero for the 90 % case. Buttons only appear once the class has started and disappear 30 min after it ends. |
| Full timetable is a sub-route of Dashboard (`/dashboard/timetable`), not a nav item | Timetable is accessed daily but doesn't need a permanent nav slot. The dashboard mini card is the entry point. Keeps bottom nav at 5 items. |
| Prayer times calculated client-side via `adhan` library | Karachi coordinates are fixed. Sun-position math works offline, costs $0, and is accurate. No API dependency. Masjid congregational times are the only thing that needs manual updating (imam has a role-gated form). |
| Announcements filtered by audience (all / batch / module) | A Surgery module announcement shouldn't appear for a student in Anatomy. Client-side filter after fetch — the query is simple and the dataset is small. |
| Revenue feature cards show "Coming Soon" from day one | Keeps the Campus cards grid layout stable. No visual shift when DowEats/Merch/Marketplace ship. Students can see what's planned. |
| Lost & Found: dashboard card + full page under Campus | Dashboard card = quick scan of latest 2-3 posts. Full page = search, filter, post. Both entry points, one component. |
| Qibla + Hijri date calculated client-side | Same principle as prayer times. Two npm libraries (`adhan` for qibla bearing, `hijri-converter` for date). Zero API calls, works offline. |

### Files touched (cumulative this session)

- `docs/decisions/ui-page-structure.md` — new, LOCKED
- `docs/decisions/mobile-web-ui.md` — nav config updated (Community → Campus, sidebar sections restructured)
- `docs/todo-current.md` — Education tab, Mobile/Web UI, and all-pages UI items ticked off

### State of the project

- Days 1–4 complete. Decision docs: `rag-architecture.md`, `model-selection.md`, `maps-platform.md`, `education-tab.md`, `mobile-web-ui.md`, `ui-page-structure.md`.
- Every screen in the app is now specced. Route tree is complete. What's left in Phase 1 is the remaining decision days (5–9): Voice/STT, AI routing, Mobile delivery, Viva orchestration, Sign-off.
- Campus digitisation tracked as parallel workstream from Day 10.

## What comes next

- **Day 5:** Voice / STT decision — test Pakistani-accent accuracy across Web Speech API, OpenAI Whisper, and Google Cloud Speech-to-Text.
