# Session 2 – 2026-02-04

## Project state at start of session

- Next.js 15 scaffold fully created: 13 route pages across `(app)/` and `(auth)/` groups, 8 shadcn/ui components, Tailwind v4, Zustand, TanStack Query — all installed and compiled.
- `/docs` populated with 7 files: PRD (overview + complete), database schema (35+ tables), design system, UX/UI guidelines, locked decisions, discovery doc.
- Git: local repo on `master`, 2 commits, no remote.
- Supabase: client packages installed (`@supabase/supabase-js`, `@supabase/ssr`), `.env.local.example` present, but no `.env.local` with real keys.
- GitHub: repo not yet created.

## What we did today

1. **Audited full project state** — read all `/docs` files, verified scaffold structure, confirmed what was and wasn't done in session 1.
2. **Created `CLAUDE.md`** — project guide covering role/facts, must-follow rules (including mandatory session logging), tech stack, folder structure, Supabase/Gemini patterns, and workflow/safety conventions. Committed to `main`.
3. **Connected Supabase** — created `.env.local` with real project URL + anon key + service-role key. Verified connection (REST endpoint returned 200 with schema). File is gitignored.
4. **Connected GitHub** — created repo `salikkhann/dowos`, renamed local branch `master` → `main`, added remote origin, pushed all 3 commits. `main` now tracks `origin/main`.
5. **Created session doc, roadmap, and todo** — `docs/sessions/2026-02-04-session-2.md`, `docs/roadmap-day-by-day.md`, `docs/todo-current.md`. All committed and pushed.
6. **Expanded roadmap with architecture decision sprint** — Phase 1 now includes 6 dedicated decision days (Days 3–8): RAG architecture, Maps platform (Google Maps vs OSM), Voice/STT, AI routing & fallback, Mobile delivery (Capacitor vs PWA), Viva Bot orchestration (LangGraph vs state machine). Each outputs a doc to `docs/decisions/`. Day 9 is sign-off + update to `FINAL_LOCKED_DECISIONS.md`.
7. **Added admin dashboard + content upload tooling** to Phase 2 roadmap — `/admin/` route group (service-role gated), MCQ/Viva/textbook upload pages, upload validation, status indicators. Created `docs/decisions/` folder with `.gitkeep`.
8. **Reviewed all skills** relevant to the project (`claude-code-guide`, `ai-engineer`, `nextjs-app-router-patterns`, `context-manager`, `cost-optimization`, `nextjs-supabase-auth`, `context-compression`, `strategic-compact`). Produced IDE + model recommendation.
9. **Fixed Supabase MCP config** — `.claude/settings.json` had `${...}` variable syntax in the URL and Bearer token. JSON does not interpolate — replaced with literal strings. MCP should now connect.
10. **Updated CLAUDE.md** with three token-efficiency rules (never bulk-read schema doc, compact at task boundaries, Sonnet by default / Opus only for decision days) and a new "Skills & Tooling" section (skills path, 9-skill reference table, MCP usage note).

## Decisions made

- Branch `master` renamed to `main` to match configured PR target.
- CLAUDE.md rule #11 / Workflow #8: session doc updates are mandatory at end of every session.
- **IDE:** Claude Code (CLI) as primary build tool. Cursor / VS Code as secondary for reading and navigation only.
- **Model routing:** Sonnet for all day-to-day coding. Opus reserved for the 6 architecture decision days (Days 3–8) only.
- **Token discipline:** Never read `docs/02_DATABASE_SCHEMA.md` in full — use Supabase MCP for live schema queries. Manual `/compact` at task boundaries, not mid-task.
- **Architecture decisions deferred, not guessed:** Maps (Google Maps vs OSM), Voice/STT, AI fallback routing, Mobile delivery, Viva Bot orchestration, and RAG design all get a dedicated evaluation day with a written decision doc before any code is written against them.
- **Admin tooling ships in Phase 2** (before AI features in Phase 3) so content team (Azfar) can seed MCQs, Viva sheets, and textbooks before students need them.

## Supabase PAT incident

- Commit `48919e3` accidentally included literal Supabase PAT (`sbp_4615d58…`) in `.claude/settings.json`.
- GitHub sent a secret-detection email. Fix: gitignored `.claude/settings.json` entirely, removed from tracking. Token rotated by user.
- `.claude/settings.json` now holds literal values on disk (MCP needs them) but is never committed.

## Phase 1 – Auth + Onboarding build (continuation)

11. **Designed onboarding questions** — every question maps 1:1 to a downstream feature. No decorative questions:
    - Batch year → timetable / module filtering
    - Roll number → viva schedule matching
    - Lab group → viva dates / attendance grouping
    - Learning style + explanation depth → Gemini system-prompt personalisation
12. **Wrote migration `00001_users.sql`** — `users` + `user_preferences` tables, CHECK constraints, `updated_at` triggers, self-only RLS on both tables.
13. **Created `src/types/database.ts`** — `User`, `UserPreferences` app-level types + SDK-compatible `Database` interface with Row/Insert/Update.
14. **Updated `src/lib/supabase.ts`** — removed `<Database>` generic (doesn't flow through `"use client"` + Turbopack); SDK defaults to `any`; app code asserts `as User` after queries.
15. **Built auth pages** — `(auth)/layout.tsx` (centred shell), `login/page.tsx` (OTP, `shouldCreateUser: false`), `signup/page.tsx` (OTP, `shouldCreateUser: true`, redirects to `/onboarding`).
16. **Built `onboarding/page.tsx`** — 5-step orchestrator: Welcome → Identity (batch/roll/lab) → Learning (style/depth) → ID upload → Pending. Resumes from DB on mount. Progress bar, ChipCard components, file preview + upload to `id_cards/<uid>/`.
17. **Wrote `middleware.ts`** — session refresh on every request; gates `/dashboard` + app routes on verified + step 4; `/onboarding` requires session; `/login`+`/signup` bounce verified users to `/dashboard`.
18. **Fixed TypeScript `never` errors** — root cause: Turbopack + `"use client"` prevents Database generic from flowing through `createBrowserClient`. Removed generic, used application-level `as User` assertions.
19. **Build passed clean** — 17 pages, 0 TypeScript errors. Only warning: Next.js 16 middleware → proxy deprecation (non-blocking, cosmetic).
20. **Pushed to `feature/auth-onboarding`** — 8 files, 974 insertions.
21. **User ran migration + created `id_cards` bucket** in Supabase Studio. Verified live via REST: `users` ✓, `user_preferences` ✓, `id_cards` bucket (public=false) ✓.
22. **Smoke-tested locally** — dev server up, all route redirects correct (`/` → `/login`, `/onboarding` no-session → `/login`, `/dashboard` no-session → `/login`), page shells render with branding + hydration scripts. Build still clean.
23. **Merged `feature/auth-onboarding` → `main`** via no-ff merge, pushed to origin. `main` is now at `f2bec80`.

## Commits this session

| Hash | Message |
|---|---|
| `b9a52b1` | docs: add CLAUDE.md project guide |
| `8403c88` | docs: add roadmap, session log, and current todo |
| `48919e3` | chore: fix Supabase MCP config, add token-efficiency rules and skills map |
| `2ef2995` | fix: remove Supabase PAT from git history |
| `057ad7e` | docs: update session 2 log with full session recap |
| `0e19b02` | feat: auth + onboarding flow (Phase 1, Days 1-2) |
| `f2bec80` | feat: merge auth + onboarding flow (Phase 1) |

## Next immediate steps

1. **Days 3–8 – Architecture decision sprint** (see `docs/roadmap-day-by-day.md` Phase 1). Each day outputs a doc to `docs/decisions/`. Use Opus for these.
2. **Day 9 – Sign-off:** review all 6 decision docs, update `docs/FINAL_LOCKED_DECISIONS.md`.
3. **Phase 2 start:** dashboard shell with bottom-nav / sidebar, dark-mode toggle, wire nav links.
4. **End-to-end auth test with real OTP:** sign up with a test @dow.edu.pk email, walk all 5 onboarding steps, upload ID, manually verify in Studio, confirm dashboard access.
