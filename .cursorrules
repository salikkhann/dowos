# DowOS Rules

## âš¡ First thing â€” read before you build

Before touching any feature, read the relevant decision doc in `docs/decisions/`. Every architectural choice is locked there. Do NOT guess or invent architecture. If a feature has no decision doc and you can't find it in `FINAL_LOCKED_DECISIONS.md`, **stop and flag it** â€” do not build anything undocumented. Ask the developer first.

Decision docs live at: `docs/decisions/`
Index of all locked decisions: `docs/FINAL_LOCKED_DECISIONS.md`
Design system: `docs/4_DESIGN_SYSTEM.md`
UX patterns + accessibility: `docs/5_UXUI_GUIDELINES.md`
Full screen wireframes + route tree: `docs/decisions/ui-page-structure.md`

---

## ğŸ›  Tech Stack

| Layer | Choice |
|---|---|
| Framework | Next.js 15 â€” App Router only. No Pages Router. No `pages/` directory. |
| Language | TypeScript strict mode. No `any`. Use `unknown` + narrowing or proper types in `src/types/`. |
| Styling | Tailwind CSS v4. shadcn/ui primitives. No CSS modules, no emotion, no styled-components. |
| State | Zustand (global app state). TanStack Query (server cache + refetch). |
| Backend / DB | Supabase â€” PostgreSQL + Realtime + Auth + Storage. |
| AI â€“ Tier 1 | Google Gemini Flash (interactive chat, MCQ explanations). |
| AI â€“ Tier 2 | DeepSeek R1 (reasoning fallback when Flash errors 3Ã—). |
| AI â€“ Extraction | Gemini 2.5 Pro (PDF text extraction via Files API only). |
| Speech â€“ STT | Groq Whisper Large v3 Turbo. NOT OpenAI Whisper. |
| Speech â€“ TTS | Google Cloud TTS. |
| Push notifications | Firebase Cloud Messaging (FCM). |
| Maps | MapLibre GL JS + PMTiles. NOT Google Maps JS SDK. |
| Prayer calc | `adhan` npm package â€” azan times + qibla bearing. Client-side only, zero API calls. |
| Hijri date | `hijri-converter` npm package. Client-side only, zero API calls. |
| Icons | Lucide React. 24 px default, 1.5 px stroke, linear style. |
| Fonts | Outfit Bold (headings). Inter (body). JetBrains Mono (scores, metrics, order codes). |
| Path alias | `@/*` â†’ `src/*`. Always use this. Never relative cross-folder imports. |
| Toasts | Sonner (shadcn toast wrapper). One instance at app root. Never stack. |
| Dark mode | next-themes. Provider at root layout. `dark:` Tailwind classes. Do NOT mirror in Zustand. |
| Error reporting | Sentry (`@sentry/nextjs`). Auto-captures unhandled exceptions. |
| Email | Resend. `RESEND_API_KEY` in `.env.local`. |

shadcn/ui components already installed: `badge`, `button`, `card`, `input`, `label`, `sheet`, `skeleton`, `tooltip`

**Do NOT install new packages.** The stack is locked. If something genuinely isn't here, flag it â€” don't npm install.

âš ï¸ **`adhan` and `hijri-converter` are NOT yet in `package.json`.** They are Phase 2A install tasks. Do NOT `import` from them until they appear in the lockfile â€” prayer features will error if you try.

ğŸ“± **Mobile:** The Next.js build is wrapped in **Capacitor.js** on iOS / Android. All code is standard web. `navigator.geolocation` works in the Capacitor webview without a plugin. Do NOT use any React Native or native mobile APIs.

---

## ğŸ¨ Design Tokens â€” use these everywhere

### Colours

| Token | Hex | Usage |
|---|---|---|
| Navy (primary) | `#1A2B4C` | Headers, body text, primary elements |
| Navy-50 | `#F8F9FB` | Light backgrounds |
| Navy-100 | `#E8EDF5` | Hover backgrounds |
| Navy-200 | `#D1DCEB` | Borders, dividers |
| Navy-300 | `#A5B8D6` | Placeholder text ONLY. NEVER for body text â€” fails contrast. |
| Navy-400 | `#6B85B3` | Focus borders |
| Offwhite | `#F5F5F7` | Page backgrounds |
| Teal | `#00A896` | CTAs, buttons, success, links, next-prayer highlight |
| Teal-500 | `#008B7D` | Teal hover state |
| Gold | `#D4A574` | Pro / Premium badges and borders |
| Red | `#E74C3C` | Errors, warnings, attendance danger |
| Sub-text on glass | `#5A6B8A` | Min-contrast text on glassmorphic cards (passes 4.5:1) |

**Dark mode overrides:**

| Token | Hex |
|---|---|
| BG | `#0F1823` |
| Card BG | `#222F45` |
| Teal (dark) | `#00D4C4` |
| Gold (dark) | `#FFD89B` |
| Red (dark) | `#FF6B5B` |

### Glassmorphism (Profile card + featured sections)

```css
background: rgba(255, 255, 255, 0.8);
backdrop-filter: blur(10px);
border: 1px solid rgba(255, 255, 255, 0.3);
border-radius: 8px;
box-shadow: 0 8px 32px rgba(31, 38, 135, 0.15);
/* Dark mode: background rgba(34, 47, 69, 0.85) */
/* Pro card: border Gold, shadow tinted rgba(212, 165, 116, 0.25) */
```

### Typography scale

| Role | Font | Weight | Size |
|---|---|---|---|
| H1 Page title | Outfit | 800 | 32 px |
| H2 Section | Outfit | 700 | 24 px |
| H3 Card header | Outfit | 700 | 18 px |
| H4 Label | Outfit | 700 | 14 px |
| Body large | Inter | 400 | 16 px |
| Body normal | Inter | 400 | 14 px |
| Body small | Inter | 400 | 12 px |
| Score / metric | JetBrains Mono | 600 | 14 px |
| Order code | JetBrains Mono | 700 | 24 px+ |

---

## ğŸ“ Layout & Spacing

- **4 px base unit.** Spacing steps: 4 / 8 / 12 / 16 / 20 / 24 / 32 / 40 / 48.
- **Mobile-first.** Every component must work on 375 px viewport. Design for this width first.
- **Touch targets:** minimum 44 Ã— 44 px on ALL interactive elements. No exceptions.
- **Breakpoints:** Mobile < 768 px Â· Tablet 768â€“1023 px Â· Desktop â‰¥ 1024 px.
- **NavShell** switches layout at 1024 px: BottomNav (mobile) â†” Sidebar (desktop).
- Cards: 16 px padding, 8 px radius, 12 px gap between cards.
- Page padding: 16 px mobile, 24 px desktop top; 40 px desktop sides.

---

## ğŸ—ºï¸ Complete Route Map â€” every file goes exactly here

`(app)/` = auth-guarded. `(auth)/` = unauthenticated login pages. **NEVER mix these two.**

```
src/app/
â”œâ”€â”€ layout.tsx                          â† root: fonts, ThemeProvider, QueryClientProvider
â”œâ”€â”€ globals.css                         â† Tailwind imports + global resets
â”œâ”€â”€ not-found.tsx                       â† global 404. No NavShell. Navy on Offwhite.
â”œâ”€â”€ error.tsx                           â† global error boundary. No NavShell.
â”‚
â”œâ”€â”€ (auth)/                             â† UNAUTHENTICATED routes
â”‚   â”œâ”€â”€ login/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â”œâ”€â”€ signup/
â”‚   â”‚   â””â”€â”€ page.tsx
â”‚   â””â”€â”€ verify/
â”‚       â””â”€â”€ page.tsx
â”‚
â””â”€â”€ (app)/                              â† AUTHENTICATED routes (NavShell wraps all)
    â”œâ”€â”€ layout.tsx                      â† mounts <NavShell />. Server Component.
    â”‚
    â”œâ”€â”€ dashboard/
    â”‚   â”œâ”€â”€ page.tsx                    â† widget stack: greeting, timetable mini, attendance, announcements, PRAYERS, L&F
    â”‚   â””â”€â”€ timetable/
    â”‚       â””â”€â”€ page.tsx                â† full timetable week-view (sub-route, not nav item)
    â”‚
    â”œâ”€â”€ ai/
    â”‚   â””â”€â”€ page.tsx                    â† AI Tutor chat screen
    â”‚
    â”œâ”€â”€ education/
    â”‚   â”œâ”€â”€ page.tsx                    â† cards grid: MCQ, Viva+Browse, Saved Qs, Progress Matrix
    â”‚   â”œâ”€â”€ mcq/
    â”‚   â”‚   â””â”€â”€ page.tsx                â† MCQ drill (source picker â†’ drill screen â†’ explanation)
    â”‚   â”œâ”€â”€ viva/
    â”‚   â”‚   â”œâ”€â”€ page.tsx                â† Viva Bot entry: module â†’ subject â†’ mode picker [Pro gate]
    â”‚   â”‚   â””â”€â”€ browse/
    â”‚   â”‚       â””â”€â”€ page.tsx            â† Browse Q&A: expandable question list [FREE]
    â”‚   â”œâ”€â”€ saved/
    â”‚   â”‚   â””â”€â”€ page.tsx                â† Saved Questions from MCQ + Browse Q&A
    â”‚   â””â”€â”€ progress/
    â”‚       â””â”€â”€ page.tsx                â† Progress Matrix heatmap
    â”‚
    â”œâ”€â”€ campus/
    â”‚   â”œâ”€â”€ page.tsx                    â† Campus cards grid: L&F, Prayers, revenue stubs
    â”‚   â”œâ”€â”€ lost-found/
    â”‚   â”‚   â””â”€â”€ page.tsx                â† Lost & Found: list + post form
    â”‚   â”œâ”€â”€ prayers/
    â”‚   â”‚   â””â”€â”€ page.tsx                â† Prayer Times full page (azan, masjid, qibla, verse)
    â”‚   â”œâ”€â”€ doweats/
    â”‚   â”‚   â””â”€â”€ page.tsx                â† [Coming Soon] stub
    â”‚   â”œâ”€â”€ merch/
    â”‚   â”‚   â””â”€â”€ page.tsx                â† [Coming Soon] stub
    â”‚   â””â”€â”€ marketplace/
    â”‚       â””â”€â”€ page.tsx                â† [Coming Soon] stub
    â”‚
    â”œâ”€â”€ maps/
    â”‚   â””â”€â”€ page.tsx                    â† MapLibre campus map (bus routes + walking paths)
    â”‚
    â”œâ”€â”€ settings/
    â”‚   â””â”€â”€ page.tsx
    â”œâ”€â”€ profile/
    â”‚   â””â”€â”€ page.tsx                    â† glassmorphic student card + photo upload
    â”œâ”€â”€ help/
    â”‚   â””â”€â”€ page.tsx
    â”‚
    â””â”€â”€ admin/                          â† service-role gated. Middleware checks users.role = 'admin'.
        â”œâ”€â”€ layout.tsx                  â† auth check: non-admin â†’ redirect /dashboard
        â”œâ”€â”€ page.tsx                    â† admin dashboard overview
        â”œâ”€â”€ content/
        â”‚   â””â”€â”€ page.tsx                â† upload (MCQ / Viva / PDF) + list + manage
        â”œâ”€â”€ approvals/
        â”‚   â””â”€â”€ page.tsx                â† Dow ID approval queue
        â”œâ”€â”€ analytics/
        â”‚   â””â”€â”€ page.tsx                â† cost + usage charts (Phase 8)
        â””â”€â”€ prayers/
            â””â”€â”€ page.tsx                â† imam form: edit masjid schedules + daily verse
```

---

## ğŸ” Auth & Middleware

Route-group auth is enforced by `src/middleware.ts` at the project root.

- Every request to an `(app)/` route: middleware reads the Supabase session via `createServerClient`. No valid session â†’ redirect to `/login`.
- `(auth)/` routes (login, signup, verify) bypass the session check entirely.
- Do NOT add auth checks inside individual page components. The middleware is the single gate.
- The middleware sets cookies required by `createServerClient` in Server Components â€” do not remove or skip it.

---

## ğŸ§­ Nav Config (locked â€” do not change without a decision doc update)

### Mobile bottom nav (5 items, 44 px tall, safe-area inset)

```
1. Dashboard   â†’ /dashboard        icon: Home
2. Education   â†’ /education        icon: Book
3. AI Tutor    â†’ /ai               icon: MessageCircle
4. Campus      â†’ /campus           icon: MapPin
5. Maps        â†’ /maps             icon: Map
```

### Desktop sidebar (config-driven via nav.ts)

```
â”€â”€ Main â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Dashboard          /dashboard
  AI Tutor           /ai

â”€â”€ Study â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  MCQ Solver         /education/mcq
  Viva Bot           /education/viva       [Pro gate] moduleâ†’subject; Browse Q&A (Free) at /education/viva/browse
  Saved Questions    /education/saved      bookmarked Qs from MCQ + Browse Q&A
  Progress Matrix    /education/progress

â”€â”€ Campus â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Lost & Found       /campus/lost-found
  Prayer Times       /campus/prayers
  DowEats            /campus/doweats       [Coming Soon]
  Dow Merch          /campus/merch         [Coming Soon]
  Marketplace        /campus/marketplace   [Coming Soon]
  Maps               /maps

â”€â”€ Identity â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  [Avatar mini-card: 48 px circle, Gold ring if Pro]
  Tap (mobile) â†’ bottom sheet: Settings / Profile / Help / Logout

â”€â”€ System â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Settings           /settings
  Profile            /profile
  Admin              /admin                [role-gated â€” only if users.role = 'admin']
  Help               /help
```

---

## ğŸ“¦ Import paths â€” always use these

| What | Pattern |
|---|---|
| shadcn/ui | `import { Button } from "@/components/ui/button"` |
| Zustand store | `import { useAuthStore } from "@/stores/auth"` |
| Custom hook | `import { useXxx } from "@/hooks/xxx"` |
| Shared type | `import type { Xxx } from "@/types/xxx"` |
| Utility | `import { xxx } from "@/lib/xxx"` |
| Supabase (browser) | `import { supabase } from "@/lib/supabase"` |

Always `@/`. Never relative paths across folders (e.g. `../../lib/foo`).

### NavShell component tree

```
src/components/nav/
â”œâ”€â”€ NavShell.tsx       â† layout wrapper. Renders BottomNav OR Sidebar based on viewport (< 1024 px / â‰¥ 1024 px).
â”œâ”€â”€ BottomNav.tsx      â† mobile nav. 5 items. 44 px tall. safe-area-inset-bottom.
â”œâ”€â”€ Sidebar.tsx        â† desktop nav. Config-driven from nav.ts.
â””â”€â”€ nav.ts             â† nav config array. Single source of truth for sidebar items, icons, routes, badges.
```

---

## ğŸ—ƒï¸ State â€” what lives where

**Zustand (global) â€” stores in `src/stores/`:**
- `useAuthStore` â€” user profile (name, email, role, isPro). Populated once after login.
- `useCreditsStore` â€” Dow Credits balance.
- `useNotifStore` â€” unread notification count.

**TanStack Query (server cache) â€” via `useQuery` in components:**
- All Supabase fetches: timetable, announcements, masjid schedules, daily verse, MCQ banks, Lost & Found listings.
- `QueryClientProvider` is in `src/app/layout.tsx` (root layout).
- Default `staleTime`: 5 min (`300_000` ms).
- Keys are arrays: `["timetable", userId]`, `["announcements"]`, `["masjid-schedules"]`.

**Local state (`useState`):** modal open/close, form values, anything that doesn't survive navigation.

**NEVER in a store:** theme (`next-themes` only), server data (TanStack Query only).

---

## ğŸŒ Environment variables

All in `.env.local`. Reference `.env.local.example`. Never hardcode.

| Variable | Scope |
|---|---|
| `NEXT_PUBLIC_SUPABASE_URL` | Browser + Server |
| `NEXT_PUBLIC_SUPABASE_ANON_KEY` | Browser (RLS-protected) |
| `SUPABASE_SERVICE_ROLE_KEY` | **Server only** â€” never in browser |
| `GEMINI_API_KEY` | Server Route Handlers |
| `GROQ_API_KEY` | Server Route Handlers |
| `GOOGLE_TTS_API_KEY` | Server Route Handlers |
| `RESEND_API_KEY` | Server Route Handlers |
| `SENTRY_DSN` | Both (auto by `@sentry/nextjs`) |

---

## ğŸ•Œ Prayer Times â€” specific rules for this feature

Prayer Times is **client-side-first**. The core calculation never hits a server or third-party API.

**Azan times (5 prayers + Sunrise):**
- Use `adhan` npm package.
- Fixed coordinates: Karachi `{ latitude: 24.8607, longitude: 67.0011 }`.
- Calculation method: **Umm al-Qura** â€” standard across Pakistan. Set via `adhan.CalculationMethod.UmmAlQura()`.
- Recalculate on every page load for today's date. Do NOT cache across days.
- Display order: Fajr â†’ Sunrise â†’ Dhuhr â†’ Asr â†’ Maghrib â†’ Isha.
- Passed prayers: show âœ“ checkmark (Teal). Next upcoming prayer: bold + Teal text.

**Qibla compass:**
- Calculate bearing via `adhan` using device geolocation (`navigator.geolocation.getCurrentPosition`).
- If user denies permission, fall back to Karachi coordinates silently â€” do not show an error.
- Render a simple compass rose (CSS or SVG). Arrow points toward Mecca. Show numeric bearing (e.g. `247Â°`).

**Hijri date:**
- Use `hijri-converter` package. Calculate from today's Gregorian date.
- Display at page top in Arabic numeral format: `6 Sha'ban 1447`.

**Masjid congregational times (jamaat):**
- These ARE stored in Supabase: `masjid_schedules` table.
- Two masjids: `masjid_id = 'dow_main'` (Dow Main Building) and `masjid_id = 'chk'` (Civil Hospital Karachi).
- Fetched server-side via TanStack Query. Show skeleton while loading.
- Updated manually by imam via `/admin/prayers`.

**Daily Verse / Hadith:**
- One row per date in `daily_content` table. Fetched server-side.
- If today's row is missing, fall back to a hardcoded default verse â€” never show an empty card.

**Dashboard mini-card:**
- Shows: next upcoming prayer name + time + live countdown (updates every second via `setInterval`).
- Always visible on Dashboard. Never conditionally hidden.
- Calculated client-side â€” same `adhan` logic, no fetch.

**Logging:**
- Fire `prayer_page_viewed` event to `app_events` when the full `/campus/prayers` page mounts.
- Prayer calc itself is local â€” no `logApiCall()` needed.

---

## ğŸ“‹ Conventions â€” follow these on every file

1. **`'use client'` only on leaf components** that need hooks (useState, useEffect, event handlers). Pages and layouts are Server Components by default. Never add `'use client'` to a layout or page unless it genuinely needs client state.
2. **Skeleton-first loading.** Every async data fetch shows `<Skeleton>` shapes while loading. No full-page spinners. Each widget / card skeletonises independently.
3. **Transitions:** 100 ms tap Â· 150 ms hover Â· 200 ms route/fade Â· 250 ms sheet. Only animate `transform` + `opacity` â€” never `width`, `height`, or `left/top`.
4. **Focus rings:** `focus-visible:ring-2 ring-teal-500 ring-offset-2` on every interactive element. No exceptions.
5. **Reduced motion:** All pulses use `motion-safe:animate-pulse`. Wrap CSS animations in `@media (prefers-reduced-motion: no-preference)`.
6. **WCAG AA minimum.** Body text contrast â‰¥ 4.5:1. NEVER use Navy-300 (`#A5B8D6`) for text on light backgrounds â€” use `#5A6B8A` as the minimum.
7. **Images:** `next/image` for every `<img>`. Explicit `width` + `height`. Add `priority` prop on above-fold images.
8. **Secrets:** All API keys, tokens, and credentials live in `.env.local` only. Access via `process.env.VARIABLE_NAME`. NEVER hardcode.
9. **Timezone:** `Asia/Karachi` (UTC+5) everywhere. Date display format: DD/MM/YYYY in UI. ISO 8601 only when an external API requires it.
10. **Currency:** PKR. All amounts in Pakistani Rupees. 1 Dow Credit = PKR 1. Never show USD.
11. **Supabase client rules:**
    - Browser (client components): `createBrowserClient()` from `src/lib/supabase.ts`.
    - Server (Server Components, Route Handlers, middleware): `createServerClient(cookies)`.
    - NEVER use `createBrowserClient` inside a Server Component â€” it will fail silently or leak.
    - RLS on every table. Students read/write own rows. Admin uses service-role client server-side only.
12. **AI rate limits (enforce server-side, not client):** AI Tutor â€” Free: soft warning at 2 msgs/day, hard block at 4. Pro: unlimited. MCQ Solver: unlimited. Viva Bot: Pro-only, 180 min/mo.
13. **Branch discipline:** NEVER push to `main`. Feature branch â†’ commit â†’ push â†’ PR â†’ merge. Always.
14. **Toasts:** Sonner via shadcn. Single instance at app root. One toast per type at a time â€” new replaces old, never stack.
15. **Dark mode:** `next-themes` `useTheme()` is the single source of truth. Provider in `app/layout.tsx`. Add `suppressHydrationWarning` on the root `<html>` tag. Use `dark:` Tailwind classes for every styled element.
16. **API call logging:** Every call to Gemini, DeepSeek, Groq, Google TTS, or Google Geocoding MUST go through `logApiCall()` from `src/lib/api-logger.ts` AFTER the call completes. Local calculations (prayer times, Hijri, qibla) do NOT need logging.
17. **Error reporting:** Sentry auto-captures unhandled exceptions. Do NOT wrap everything in `try/catch` with `Sentry.captureException()` â€” let unhandled errors bubble. Only manually capture if the error would otherwise be completely swallowed.
18. **Admin auth â€” two layers:**
    (1) `admin/layout.tsx` middleware checks `users.role = 'admin'`. Non-admins redirect to `/dashboard`.
    (2) Admin API / Route Handlers use the service-role Supabase client. The service-role key is NEVER sent to the browser.
19. **404 / error pages:** `not-found.tsx` and `error.tsx` at `src/app/` root. Minimal centered layout â€” no NavShell wrapper. Navy text on Offwhite. Simple message + "â† Back" button.
20. **Upload pipeline:** Long-running admin jobs (PDF extraction, citation enrichment, explanation-fix) run as Vercel Route Handlers and stream progress via SSE. See `docs/decisions/upload-pipeline.md`.
21. **Server actions:** Place in a dedicated `actions/` subfolder per feature directory. Add `'use server'` at the top of the file. Return typed results â€” never `throw` from a server action; return `{ error: string }` instead so the UI can handle it.
22. **Pro paywall gates:** Check Pro status server-side before returning Viva Bot data or unlocking AI Tutor limits. Client-side gate is UI-only â€” it can be bypassed. The real enforcement is the Route Handler / server action.

---

## ğŸš« NEVER do these â€” hard stops

If you are about to do any of the following, stop immediately. These are non-negotiable.

1. **NEVER use Pages Router.** No `pages/` directory anywhere. No `getServerSideProps`. No `getStaticProps`. No `getInitialProps`. App Router Server Components + `'use client'` leaves only.
2. **NEVER install a new npm package.** The stack is locked. Check `package.json` first. If something is genuinely missing, flag it to the developer â€” do not install.
3. **NEVER use the `any` type.** TypeScript strict mode. Define types in `src/types/` or use `unknown` + type narrowing.
4. **NEVER hardcode API keys or secrets.** `.env.local` only. Always `process.env.VARIABLE_NAME`.
5. **NEVER call an external AI/ML provider without `logApiCall()`.** Gemini, DeepSeek, Groq, Google TTS, Google Geocoding â€” every single one must be logged. Local calc (prayer, hijri, qibla) is exempt.
6. **NEVER create a file outside the route map defined above.** File-system IS routing in Next.js App Router. A file in the wrong folder = a page at the wrong URL or an unreachable page.
7. **NEVER use `createBrowserClient` inside a Server Component.** Server Components use `createServerClient(cookies)`.
8. **NEVER use CSS modules, styled-components, or emotion.** Tailwind v4 + shadcn/ui only. Period.
9. **NEVER skip the skeleton state.** Every async page or widget that fetches data must show `<Skeleton>` shapes while loading.
10. **NEVER use an API or fetch to calculate prayer times, Hijri dates, or Qibla direction.** These are computed client-side via `adhan` and `hijri-converter`. Zero network calls for this data.
11. **NEVER expose the service-role Supabase key to the browser.** It grants full database access with no RLS. Server-side Route Handlers only.
12. **NEVER push directly to `main`.** Feature branch â†’ commit â†’ push â†’ merge. Always.
13. **NEVER use Navy-300 (`#A5B8D6`) for body text on light backgrounds.** Fails WCAG AA contrast. Use `#5A6B8A` as minimum.
14. **NEVER stack toasts.** Sonner replaces â€” one toast per type at a time.
15. **NEVER mirror theme state in Zustand or any other store.** `next-themes` `useTheme()` is the single source of truth.
16. **NEVER put an auth-guarded page in `(auth)/` or an unauthenticated page in `(app)/`.** Auth boundary is defined by the route group. Never mix.
17. **NEVER throw from a server action.** Return `{ error: string }` so the UI can display a toast. Throwing crashes the request silently.
18. **NEVER enforce Pro-tier limits client-side only.** Client gates are UI-only sugar. Real enforcement must happen server-side in the Route Handler or server action.

---

## ğŸš¨ Stop-and-flag checklist

Run through every single item before you ship a component. All must pass.

- [ ] **Decision doc exists** for this feature? â†’ No doc = stop. Flag it. Do not build.
- [ ] **Route path matches the route map** in this file? â†’ Wrong path = unreachable page or wrong URL.
- [ ] **File is in the correct route group?** `(app)/` for auth-guarded, `(auth)/` for login pages. Never mix.
- [ ] **Touch targets â‰¥ 44 Ã— 44 px** on every button, link, nav item, and tappable element?
- [ ] **Skeleton state** implemented for every async data fetch? No spinners.
- [ ] **Dark mode classes (`dark:`)** present on every styled element? Test by toggling.
- [ ] **Focus ring** (`focus-visible:ring-2 ring-teal-500 ring-offset-2`) on every interactive element?
- [ ] **No hardcoded secrets?** All keys from `.env.local` via `process.env`.
- [ ] **`next/image`** used for every image? With explicit `width` + `height`?
- [ ] **`logApiCall()`** wired after every external AI/ML call? (Skip for local prayer/hijri calc.)
- [ ] **`npm run build`** passes with zero errors before you hand off?
- [ ] **Tested at 375 px viewport width?**
- [ ] **Pro paywall enforced server-side**, not client-side only?
- [ ] **Server actions return typed results**, never throw?
